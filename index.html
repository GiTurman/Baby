<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KIDDO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap');
        body { background-color: #fef9f3; font-family: 'Playfair Display', serif; }
        .card { background: white; border-radius: 35px; border: 1px solid #f3e5d8; box-shadow: 0 10px 25px rgba(0,0,0,0.02); }
    </style>
</head>
<body class="p-4 md:p-10">

    <div id="loginGate" class="fixed inset-0 bg-[#fef9f3] z-[9999] flex items-center justify-center">
        <div class="card p-10 w-full max-w-sm text-center mx-4">
            <h2 class="text-4xl font-bold text-orange-950 mb-10 italic">KIDDO</h2>
            <div class="grid gap-4">
                <button onclick="enter('Giorgi')" class="py-4 bg-white border-2 border-orange-100 rounded-2xl font-bold text-orange-900 hover:bg-orange-50 transition">Giorgi</button>
                <button onclick="enter('Ana')" class="py-4 bg-white border-2 border-orange-100 rounded-2xl font-bold text-orange-900 hover:bg-orange-50 transition">Ana</button>
                <button onclick="enter('Baiko')" class="py-4 bg-white border-2 border-orange-100 rounded-2xl font-bold text-orange-900 hover:bg-orange-50 transition">Baiko</button>
            </div>
        </div>
    </div>

    <div id="mainApp" class="max-w-xl mx-auto hidden">
        <header class="flex justify-between items-center mb-10">
            <h1 class="text-3xl font-bold text-orange-950 italic">KIDDO</h1>
            <div class="text-right">
                <p id="userLabel" class="text-[10px] text-orange-500 font-bold uppercase tracking-widest"></p>
                <button onclick="localStorage.removeItem('k_user'); location.reload()" class="text-[10px] text-gray-400 underline">·Éí·Éê·Éõ·Éù·É°·Éï·Éö·Éê</button>
            </div>
        </header>

        <div class="card p-8 mb-12 border-t-8 border-orange-100">
            <textarea id="noteInp" class="w-full text-xl outline-none bg-transparent mb-6 h-24" placeholder="·É†·Éê ·Éõ·Éù·ÉÆ·Éì·Éê ·Éì·É¶·Éî·É°?"></textarea>
            
            <div id="pBox" class="hidden mb-6 relative">
                <button onclick="clearImg()" class="absolute top-2 right-2 bg-red-500 text-white w-6 h-6 rounded-full text-xs">‚úï</button>
                <img id="pImg" class="w-full h-56 object-cover rounded-[30px]">
            </div>

            <div class="mb-8 p-4 bg-orange-50/50 rounded-2xl flex justify-between items-center border border-orange-100">
                <span class="text-[10px] font-bold text-orange-400 uppercase">·Éó·Éê·É†·Éò·É¶·Éò:</span>
                <input type="date" id="mDate" class="bg-transparent font-bold text-orange-900 outline-none cursor-pointer">
            </div>

            <input type="file" id="fInp" class="hidden" onchange="preview(this)">
            <button onclick="document.getElementById('fInp').click()" class="text-orange-800 text-xs font-bold mb-8 hover:underline">üñºÔ∏è ·É§·Éù·É¢·Éù·É° ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éê</button>
            
            <button id="saveBtn" onclick="save()" class="w-full py-5 bg-gradient-to-r from-orange-400 to-pink-500 text-white rounded-2xl font-bold shadow-xl active:scale-95 transition">·É©·Éê·É¨·Éî·É†·Éî ·É¨·Éò·Éí·Éú·É®·Éò ‚ú®</button>
        </div>

        <div id="feed" class="space-y-12 pb-32"></div>
    </div>

    <script>
        const KEY = "AIzaSyAGhXxxykU-NrVR7fE_Re6GkRfAB7dI52g";
        let user = localStorage.getItem('k_user');
        let img = null;

        document.getElementById('mDate').valueAsDate = new Date();

        function enter(name) {
            localStorage.setItem('k_user', name);
            user = name;
            init();
        }

        function init() {
            if (!user) return;
            document.getElementById('loginGate').style.display = 'none';
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userLabel').innerText = `·Éê·Éï·É¢·Éù·É†·Éò: ${user}`;
            render();
        }

        if (user) init();

        function preview(input) {
            if (input.files && input.files[0]) {
                const r = new FileReader();
                r.onload = e => {
                    img = e.target.result;
                    document.getElementById('pImg').src = img;
                    document.getElementById('pBox').classList.remove('hidden');
                };
                r.readAsDataURL(input.files[0]);
            }
        }

        function clearImg() {
            img = null;
            document.getElementById('pBox').classList.add('hidden');
            document.getElementById('fInp').value = "";
        }

        async function save() {
            const txt = document.getElementById('noteInp').value;
            const date = document.getElementById('mDate').value;
            if (!txt) return;

            const btn = document.getElementById('saveBtn');
            btn.innerText = "KIDDO ·É§·Éò·É•·É†·Éù·Éë·É°...";
            btn.disabled = true;

            try {
                // ·Éñ·É£·É°·É¢·Éò API ·Éõ·Éò·É°·Éê·Éõ·Éê·É†·Éó·Éò (v1beta)
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: `·É®·Éî·Éú ·ÉÆ·Éê·É† KIDDO. ·Éí·Éê·Éì·Éê·Éê·É•·É™·Éò·Éî ·Éî·É° ·É§·É†·Éê·Éñ·Éê ·Éó·Éë·Éò·Éö ·Éõ·Éù·Éí·Éù·Éú·Éî·Éë·Éê·Éì ·É•·Éê·É†·Éó·É£·Éö ·Éî·Éú·Éê·Éñ·Éî (100 ·É°·Éò·É¢·Éß·Éï·Éê): "${txt}"` }] }] })
                });
                
                const data = await res.json();
                const story = data.candidates[0].content.parts[0].text;

                const dbKey = `kiddo_data_${user}`;
                const history = JSON.parse(localStorage.getItem(dbKey) || '[]');
                history.unshift({ id: Date.now(), story, img, date });
                localStorage.setItem(dbKey, JSON.stringify(history));

                document.getElementById('noteInp').value = "";
                clearImg();
                render();
            } catch (e) {
                alert("·Éë·Éù·Éì·Éò·É®·Éò, ·Éô·Éê·Éï·É®·Éò·É†·Éò ·Éí·Éê·É¨·Éß·Éì·Éê. ·É°·É™·Éê·Éì·Éî ·Éó·Éê·Éï·Éò·Éì·Éê·Éú.");
            } finally {
                btn.innerText = "·É©·Éê·É¨·Éî·É†·Éî ·É¨·Éò·Éí·Éú·É®·Éò ‚ú®";
                btn.disabled = false;
            }
        }

        function render() {
            const container = document.getElementById('feed');
            container.innerHTML = "";
            const history = JSON.parse(localStorage.getItem(`kiddo_data_${user}`) || '[]');
            
            history.forEach(m => {
                const d = new Date(m.date).toLocaleDateString('ka-GE', { day: 'numeric', month: 'long', year: 'numeric' });
                container.innerHTML += `
                    <div class="card p-10 border-l-[10px] border-orange-100 relative group">
                        <button onclick="del(${m.id})" class="absolute top-4 right-4 text-red-200 opacity-0 group-hover:opacity-100 transition text-[10px]">·É¨·Éê·É®·Éö·Éê</button>
                        <p class="text-[10px] font-bold text-orange-300 uppercase mb-6 tracking-widest">${d}</p>
                        ${m.img ? `<img src="${m.img}" class="w-full h-72 object-cover rounded-[40px] mb-8 shadow-sm">` : ''}
                        <p class="text-orange-950 text-2xl leading-relaxed italic">${m.story}</p>
                    </div>`;
            });
        }

        function del(id) {
            if(!confirm('·É¨·Éê·Éï·É®·Éê·Éö·Éù·Éó?')) return;
            const dbKey = `kiddo_data_${user}`;
            let history = JSON.parse(localStorage.getItem(dbKey) || '[]');
            history = history.filter(x => x.id !== id);
            localStorage.setItem(dbKey, JSON.stringify(history));
            render();
        }
    </script>
</body>
</html>
